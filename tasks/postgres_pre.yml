---

- set_fact:
    db_info_partial:
     - enabled:       "{{ ripple_connect_enabled | default(False) }}"
       db_host:       "{{ ripple_connect_db_host | default(omit) }}"
       db_port:       "{{ ripple_connect_db_port | default(omit) }}"
       db_user:       "{{ ripple_connect_db_user | default(omit) }}"
       db_pass:       "{{ ripple_connect_db_pass | default(omit) }}"
       db_name:       "{{ ripple_connect_db_name | default(omit) }}"
       db_admin_user: "{{ ripple_connect_db_admin_user | default(omit) }}"
       db_admin_pass: "{{ ripple_connect_db_admin_pass | default(omit) }}"
     - enabled:       "{{ ilp_validator_enabled | default(False) }}"
       db_host:       "{{ ilp_validator_db_host | default(omit) }}"
       db_port:       "{{ ilp_validator_db_port | default(omit) }}"
       db_user:       "{{ ilp_validator_db_user | default(omit) }}"
       db_pass:       "{{ ilp_validator_db_pass | default(omit) }}"
       db_name:       "{{ ilp_validator_db_name | default(omit) }}"
       db_admin_user: "{{ ilp_validator_db_admin_user | default(omit) }}"
       db_admin_pass: "{{ ilp_validator_db_admin_pass | default(omit) }}"
     - enabled:       "{{ fx_connector_enabled | default(False) }}"
       db_host:       "{{ fx_connector_db_host | default(omit) }}"
       db_port:       "{{ fx_connector_db_port | default(omit) }}"
       db_user:       "{{ fx_connector_db_user | default(omit) }}"
       db_pass:       "{{ fx_connector_db_pass | default(omit) }}"
       db_name:       "{{ fx_connector_db_name | default(omit) }}"
       db_admin_user: "{{ fx_connector_db_admin_user | default(omit) }}"
       db_admin_pass: "{{ fx_connector_db_admin_pass | default(omit) }}"

- set_fact:
    db_info: "{{ (db_info_partial + ilp_ledgers) | list }}"

- name: "Create Databases"
  postgresql_db:
    login_host:     "{{ item.db_host }}"
    login_user:     "{{ item.db_admin_user }}"
    login_password: "{{ item.db_admin_pass }}"
    port:           "{{ item.db_port }}"
    name:           "{{ item.db_name }}"
    encoding:       UTF-8
    template:       template0
  when: item.enabled | default(False) | bool
  with_items:
   - "{{ db_info }}"

- name: "Create Users"
  postgresql_user:
    login_host:      "{{ item.db_host }}"
    login_user:      "{{ item.db_admin_user }}"
    login_password:  "{{ item.db_admin_pass }}"
    port:            "{{ item.db_port }}"
    name:            "{{ item.db_user }}"
    password:        "{{ item.db_pass }}"
    db:              "{{ item.db_name }}"
    priv:            ALL
    role_attr_flags: NOSUPERUSER,NOCREATEDB
    no_password_changes: yes
  when: item.enabled | default(False) | bool
  with_items:
   - "{{ db_info }}"

- name: "Lock DB for Other Users"
  postgresql_privs:
    login_host:      "{{ item.db_host }}"
    login_user:      "{{ item.db_admin_user }}"
    login_password:  "{{ item.db_admin_pass }}"
    port:            "{{ item.db_port }}"
    db:              "{{ item.db_name }}"
    role:            PUBLIC
    type:            database
    priv:            ALL
    state:           absent
  when: item.enabled | default(False) | bool
  with_items:
   - "{{ db_info }}"
