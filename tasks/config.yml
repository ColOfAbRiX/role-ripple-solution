---

#
# Passwords encryption
#

- name: "Encrypt Known Remotes Passwords"
  shell: "node /opt/ripple-solution/scripts/encrypt_string.js {{ key_path }}/{{ ripple_solution_admin_crt_prefix }}-key.pem <<<{{ item.password }}"
  register: encrypted_known_remote_passwords
  with_items:
   - "{{ ripple_solution_known_remotes }}"

- name: "Encrypt Database Passwords"
  shell: "node /opt/ripple-solution/scripts/encrypt_string.js {{ key_path }}/{{ ripple_solution_admin_crt_prefix }}-key.pem <<<{{ ripple_connect_db_pass }}"
  register: encrypted_database_password

#
# Passwords hashing
#

- name: "Hash Partner Passwords"
  shell: "node /opt/ripple-solution/scripts/hash_password.js <<<{{ item.username }}:RippleSolution:{{ item.password }}"
  register: hashed_partner_passwords
  with_items:
   - "{{ ripple_solution_partners }}"

- name: "Hash Operator Passwords"
  shell: "node /opt/ripple-solution/scripts/hash_password.js <<<{{ item.username }}:RippleSolution:{{ item.password }}"
  register: hashed_operator_passwords
  with_items:
   - "{{ ripple_solution_operators }}"

- name: "Hash Custom Rate Operator Passwords"
  shell: "node /opt/ripple-solution/scripts/hash_password.js <<<{{ item.username }}:RippleSolution:{{ item.password }}"
  register: hashed_custom_rate_operators_passwords
  with_items:
   - "{{ ripple_solution_custom_rate_operator }}"

- name: "Hash Monitor Passwords"
  shell: "node /opt/ripple-solution/scripts/hash_password.js <<<{{ item.username }}:RippleSolution:{{ item.password }}"
  register: hashed_monitor_passwords
  with_items:
   - "{{ ripple_solution_monitors }}"

#
# Configuration files
#

- name: "Construct Files Content"
  set_fact:
    database_file:
      dialect:  "{{ ripple_solution_db_dialect }}"
      host:     "{{ ripple_connect_db_host }}"
      port:     "{{ ripple_connect_db_port | string }}"
      database: "{{ ripple_connect_db_name }}"

    server_file:
      secure: "{{ ripple_connect_secure }}"
      port:   "{{ ripple_connect_port | string }}"
      host:   "{{ ripple_connect_host }}"
      server_key_path:         "{{ key_path }}/{{ ripple_connect_crt_prefix }}-key.pem"
      server_certificate_path: "{{ cert_path }}/{{ ripple_connect_crt_prefix }}-crt.pem"
      server_ca_paths:
       - "{{ cert_path }}/provider-ca-crt.pem"
       - "{{ cert_path }}/consumer-ca-crt.pem"

    config_file: "{{ ripple_connect_config }}"

- name: "Clean Examples"
  shell: "rm -f {{ ripple_solution_config_base }}/*example*"
  changed_when: false

- name: "Install Configuration Files"
  template:
    src:    "{{ item }}.j2"
    dest:   "{{ ripple_solution_config_base }}/{{ item }}"
    mode:   '0644'
    force:  yes
    owner:  "{{ ripple_solution_user }}"
    group:  "{{ ripple_solution_group }}"
    seuser: system_u
    serole: object_r
    setype: usr_t
  with_items:
   - config-ilp.json
   - config.json
   - database.json
   - entities.json
   - secrets.json
   - server.json
